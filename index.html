<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrunoStock ‚Äî Ultimate Neon Ultimate</title>
    
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
html {
    font-size: 16px;
}
        :root {
    --bg: radial-gradient(circle at top, #001a26, #000814 70%);
    --card: rgba(8, 25, 40, 0.95);
    --gold: #d4af37;
    --gold-soft: #f1d27a;
    --ocean: #0077b6;
    --ocean-light: #00b4d8;
    --ocean-deep: #023e8a;
    --text: #f5f9ff;
    --border: rgba(212, 175, 55, 0.15);
    --shadow-gold: 0 0 25px rgba(212,175,55,0.4);
--blue-neon: var(--ocean-light);
--red-neon: #c1121f;
--green-neon: #00c853;
}

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, sans-serif; }
       body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    transition: 0.4s ease;
}
body.light {
    --bg: #f2f5f9;
    --card: #ffffff;
    --text: #111;
    --border: #ddd;
    --gold: #b68c00;
    --blue-neon: #0077b6;
}

body.light header {
    background: #ffffff;
}

body.light nav {
    background: #ffffff;
}

body.light .card {
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}
        /* Barra de rolagem customizada para manter a est√©tica Neon */
        .container, .scroll-area, #prod-list-container, #cart-items { 
            overflow-y: auto !important; 
            scrollbar-width: thin; 
            scrollbar-color: var(--gold) transparent; 
        }
        .container::-webkit-scrollbar, .scroll-area::-webkit-scrollbar { width: 6px; }
        .container::-webkit-scrollbar-thumb, .scroll-area::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

/* ================= SCROLL LATERAL GLOBAL ================= */

.container, 
#prod-list-container, 
#cart-items,
#report-content,
#quick-results {
    overflow-x: hidden;
}

/* Scroll horizontal neon */
.container::-webkit-scrollbar,
#prod-list-container::-webkit-scrollbar,
#cart-items::-webkit-scrollbar,
#report-content::-webkit-scrollbar,
#quick-results::-webkit-scrollbar {
    height: 6px;
}

.container::-webkit-scrollbar-thumb,
#prod-list-container::-webkit-scrollbar-thumb,
#cart-items::-webkit-scrollbar-thumb,
#report-content::-webkit-scrollbar-thumb,
#quick-results::-webkit-scrollbar-thumb {
    background: var(--blue-neon);
    border-radius: 10px;
}

/* ================= AGRUPAMENTO VISUAL ================= */

.group-header {
    margin-top: 18px;
    padding: 10px;
    background: linear-gradient(90deg, rgba(255,204,0,0.1), transparent);
    border-left: 4px solid var(--gold);
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--gold);
    border-radius: 10px;
}

.validade-header {
    margin-top: 10px;
    padding: 6px;
    background: rgba(0,242,255,0.05);
    border-left: 3px solid var(--blue-neon);
    font-size: 0.8rem;
    color: var(--blue-neon);
    border-radius: 8px;
}

        .container {
    padding: 12px;
    flex: 1; 
    width: 100%; 
    max-width: 1100px; 
    margin: 0 auto; 
    padding-bottom: 140px; 
}

        .card { 
            background: var(--card); backdrop-filter: blur(20px); border-radius: 28px; 
            padding: 22px; margin-bottom: 20px; border: 1px solid var(--border); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); transition: transform 0.2s;
        }

        .btn { 
    width: 100%; 
    padding: 16px; 
    border: none; 
    border-radius: 18px; 
    font-weight: 700; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 10px; 
    cursor: pointer; 
    transition: 0.3s ease; 
    text-transform: uppercase; 
}

/* OURO LUXO */
.btn-gold { 
    background: linear-gradient(135deg, var(--gold), var(--gold-soft));
    color: #000;
    box-shadow: 0 0 20px rgba(212,175,55,0.4);
}

.btn-gold:hover { 
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(212,175,55,0.6);
}

/* AZUL OCEANO PREMIUM */
.btn-blue { 
    background: linear-gradient(135deg, var(--ocean-light), var(--ocean));
    color: white;
    box-shadow: 0 0 20px rgba(0,180,216,0.4);
}

.btn-blue:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(0,180,216,0.6);
}

/* VERMELHO PROFISSIONAL */
.btn-red { 
    background: linear-gradient(135deg, #8b0000, #c1121f);
    color: white;
    box-shadow: 0 0 15px rgba(193,18,31,0.4);
}
        .btn-mini { padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; }

        input, select { 
            width: 100%; padding: 15px; background: rgba(0,0,0,0.2); border: 1.5px solid var(--border); 
            border-radius: 14px; color: var(--text); margin-top: 10px; font-size: 1rem; outline: none; 
        }
        body.light input, body.light select { background: #f9f9f9; color: #000; border-color: #ccc; }
        input:focus { border-color: var(--blue-neon); box-shadow: 0 0 8px var(--blue-neon); }

        header { padding: 15px 25px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .logo-b { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--gold); box-shadow: 0 0 10px var(--gold); }

        nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; padding: 12px 0 35px 0; border-top: 1px solid var(--border); z-index: 999; }
        .nav-item { color: #888; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.7rem; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--gold); }

        #scanner { display:none; position:fixed; inset:0; z-index:100000; background:#000; }
        .hidden { display: none !important; }
        .dot { width: 20px; height: 20px; border: 2px solid var(--gold); border-radius: 50%; transition: 0.3s; }
        .blur-value { filter: blur(10px); }
        
        .prod-row { 
            display: flex; justify-content: space-between; align-items:center; 
            padding: 14px; border-bottom: 1px solid rgba(128,128,128,0.1); cursor: pointer; 
            transition: background 0.2s;
        }
        .prod-row:hover { background: rgba(255, 204, 0, 0.05); }
        
        #report-modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            z-index: 100001; background: var(--card); padding: 25px; border-radius: 30px; 
            border: 2px solid var(--gold); width: 92%; max-width: 450px; max-height: 85vh; 
            display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .report-line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(128,128,128,0.2); font-weight: 500; }
        
        /* Estilo para itens do carrinho com controles */
        .cart-item-ui { display: flex; flex-direction: column; gap: 5px; padding: 10px; border-bottom: 1px solid var(--border); }
        .cart-controls { display: flex; align-items: center; gap: 15px; margin-top: 5px; }
        .qty-btn { background: var(--gold); color: #000; border: none; width: 25px; height: 25px; border-radius: 5px; font-weight: bold; cursor: pointer; }
/* ================= RESPONSIVIDADE AVAN√áADA ================= */

@media (min-width: 768px) {

    .container {
        max-width: 900px;
    }

    #view-vendas .card {
        transition: transform 0.2s ease;
    }

    #view-vendas .card:hover {
        transform: translateY(-3px);
    }

    #cart-items {
        max-height: 350px;
    }

    #prod-list-container {
        max-height: 400px;
    }

}

@media (min-width: 1200px) {

    .container {
        max-width: 1200px;
    }

    nav {
        max-width: 1200px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 18px 18px 0 0;
    }

}
/* ===== Assinatura Profissional ===== */

.dev-signature {
    text-align: center;
    font-size: 0.65rem;
    color: #777;
    padding: 20px 10px 120px 10px; /* espa√ßo por causa do menu fixo */
    line-height: 1.4;
    letter-spacing: 0.5px;
    opacity: 0.7;
}

.dev-signature div:nth-child(3) {
    color: var(--gold);
    font-weight: 600;
}

.dev-signature:hover {
    opacity: 1;
}
    </style>
</head>
<body class="dark">

    <div class="hidden">
        <audio id="snd-bip" src="bip.mp3"></audio>
        <audio id="snd-caixa" src="caixa.mp3"></audio>
        <audio id="snd-erro" src="erro.mp3"></audio>
        <audio id="snd-alerta" src="alerta.mp3"></audio>
        <audio id="snd-troca" src="troca.mp3"></audio>
        <audio id="snd-limpar" src="limpar.mp3"></audio>
    </div>

    <div id="pinScreen"
style="position:fixed;
top:0;
left:0;
width:100%;
height:100vh;
background: radial-gradient(circle at top, #002b3a, #000814 70%);
z-index:99999;
display:flex;
align-items:center;
justify-content:center;
overflow:hidden;">

    <!-- FUNDO ANIMADO -->
    <canvas id="goldParticles"
    style="position:absolute; inset:0; z-index:0;"></canvas>

    <div style="position:relative;
            z-index:1;
            text-align:center;
            width:100%;
            max-width:380px;
            margin:0 auto;
            padding:25px 20px;
            display:flex;
            flex-direction:column;
            justify-content:center;">

        <img src="logo.png"
        style="width:120px; height:120px; border-radius:50%;
        border:4px solid var(--gold); margin-bottom:25px;
        box-shadow:0 0 25px var(--gold);">

        <h2 style="color:var(--gold);
        letter-spacing:6px; margin-bottom:10px;">
        BRUNOSTOCK
        </h2>

        <div id="pin-dots"
style="display:flex;
justify-content:center;
align-items:center;
gap:18px;
margin:35px auto;
width:100%;">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>

      <div style="display:grid;
grid-template-columns:repeat(3, minmax(70px, 22vw));
gap:4vw;
justify-content:center;
max-width:320px;
margin:25px auto 0 auto;">

<script>
for(let i=1;i<=9;i++){
    document.write(
        '<button onclick="typePin(\''+i+'\')" class="btn btn-gold" ' +
        'style="border-radius:50%;width:100%;aspect-ratio:1/1;font-size:clamp(1.2rem,4vw,1.6rem);">' +
        i +
        '</button>'
    );
}
</script>

<button onclick="location.reload()"
class="btn btn-red"
style="border-radius:50%;width:100%;aspect-ratio:1/1;">
<i class="fa-solid fa-rotate"></i>
</button>

<button onclick="typePin('0')"
class="btn btn-gold"
style="border-radius:50%;
       width:100%;
       aspect-ratio:1/1;
       font-size:clamp(1.2rem,4vw,1.6rem);">
0
</button>

<button onclick="resetPin()"
class="btn btn-blue"
style="border-radius:50%;
       width:100%;
       aspect-ratio:1/1;
       background:transparent;
       border:2px solid var(--blue-neon);
       color:var(--blue-neon);">
<i class="fa-solid fa-eraser"></i>
</button>

</div>

        <small id="pin-copyright"
        style="margin-top:50px; display:block;
        color:#777; font-size:0.7rem;"></small>

    </div>
</div>

    <div id="mainApp" class="hidden">
        <header>
            <div style="display:flex; align-items:center; gap:14px;">
                <img src="logo.png" class="logo-b" onerror="this.src='https://via.placeholder.com/50'">
                <b style="color:var(--gold); letter-spacing: 1px;">BRUNOSTOCK Ultimate</b>
            </div>
            <div style="display:flex; gap:20px; align-items:center;">
                <i id="eye-icon" class="fa-solid fa-eye" onclick="togglePrivacy()" style="color:var(--blue-neon); cursor:pointer;"></i>
                <i class="fa-solid fa-circle-half-stroke" onclick="toggleTheme()" style="color:var(--gold); cursor:pointer;"></i>
                <i class="fa-solid fa-power-off" onclick="logout()" style="color:var(--red-neon); cursor:pointer;"></i>
            </div>
        </header>

        <div class="container">
            <div id="view-vendas">
                <div id="venc-box" class="hidden card" style="border-left: 6px solid var(--red-neon); background: rgba(255,0,85,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <small style="color:var(--red-neon); font-weight:900;">‚ö†Ô∏è ALERTA DE VALIDADE</small>
                        <button onclick="muteAlert()" style="background:var(--red-neon); border:none; color:white; border-radius:10px; padding:6px 12px; font-size:0.7rem; cursor:pointer;">CIENTE</button>
                    </div>
                    <div id="venc-list" class="scroll-area" style="margin-top:10px; font-size:0.85rem; max-height: 80px;"></div>
                </div>

                <div class="card" style="text-align:center; position:relative; overflow:hidden;">
                    <small style="letter-spacing:3px; color: var(--gold); font-weight: 700;">FATURAMENTO HOJE</small>
                    <h1 id="dash-vendas" class="privacy-target" style="font-size:3.2rem; margin:15px 0; color:var(--text); font-weight: 800;">R$ 0,00</h1>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; border-top:1px solid rgba(128,128,128,0.2); padding-top:20px;">
                        <div><small>LUCRO L√çQUIDO</small><br><b id="dash-lucro" class="privacy-target" style="color:var(--green-neon); font-size:1.2rem;">R$ 0,00</b></div>
                        <div><small>TOTAL FIADO</small><br><b id="dash-fiado" class="privacy-target" style="color:var(--red-neon); font-size:1.2rem;">R$ 0,00</b></div>
                    </div>
<div class="card">
    <small style="color:var(--gold); font-weight:700;">CAIXA DE ENTRADA DO DIA</small>
    <input type="number" id="cash-start" placeholder="Digite o valor inicial em R$">
    <button class="btn btn-gold" style="margin-top:10px;" onclick="saveCashStart()">SALVAR CAIXA</button>
    <div id="cash-status" style="margin-top:8px; font-size:0.8rem; color:var(--green-neon);"></div>
</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="card" style="text-align:center;"><small>USO CASA</small><br><span id="dash-casa" class="privacy-target" style="color:var(--blue-neon); font-weight:bold;">R$ 0,00</span></div>
                    <div class="card" style="text-align:center;"><small>PERDAS/AVARIAS</small><br><span id="dash-perda" class="privacy-target" style="color:var(--red-neon); font-weight:bold;">R$ 0,00</span></div>
                </div>

                <div style="text-align: center; margin-top: 10px;">
                    <small style="color: #666; font-weight: 600;"></small>
                </div>
            </div>

            <div id="view-balcao" class="hidden">
                <div class="card" style="margin-bottom: 15px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <button class="btn btn-gold" onclick="openScan('venda')"><i class="fa-solid fa-barcode"></i> BIPAR</button>
                        <button class="btn btn-red" onclick="openScan('troca')"><i class="fa-solid fa-rotate-left"></i> TROCA</button>
                    </div>
                    <input type="text" id="search-balcao" placeholder="üîç Pesquisar por nome ou EAN..." oninput="quickSearchBalcao(this.value)" style="margin-top:15px;">
                    <div id="quick-results" class="scroll-area" style="max-height:120px; background:rgba(0,0,0,0.3); border-radius:10px; margin-top:5px;"></div>
                </div>
                
                <div class="card" style="border: 1px solid var(--blue-neon);">
                    <div id="cart-items" style="min-height:150px; max-height: 220px; margin-bottom:15px;"></div>
                    <div style="text-align:center; border-top: 1px dashed #555; padding-top: 15px;">
                        <small style="font-weight:bold;">TOTAL DO CARRINHO</small>
                        <h2 id="cart-total" style="color:var(--green-neon); font-size:2.8rem; margin:5px 0; font-weight:900;">R$ 0,00</h2>
                    </div>
                    <select id="pay-method">
                        <option value="dinheiro">üíµ DINHEIRO / PIX</option>
                        <option value="cartao">üí≥ CART√ÉO (CR√âD/D√âB)</option>
                        <option value="fiado">üìù FIADO (CADERNETA)</option>
                        <option value="casa">üè† USO CASA (CONSUMO)</option>
                        <option value="avaria">‚ö†Ô∏è AVARIA / PERDA</option>
                    </select>
                    <button class="btn btn-blue" style="margin-top:20px; font-size: 1.1rem;" onclick="closeSale()">FECHAR CAIXA</button>
                    <button onclick="clearCart()" style="background:none; border:none; color:#777; width:100%; margin-top:15px; cursor:pointer;">LIMPAR TUDO</button>
                </div>
            </div>

            <div id="view-estoque" class="hidden">
                <div class="card">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-gold" onclick="openScan('estoque')"><i class="fa-solid fa-camera"></i> EAN</button>
                        <button class="btn btn-gold" onclick="generateManualCode()" style="border-color: var(--blue-neon); color: var(--blue-neon);">GERAR</button>
                    </div>
                    
                    <input type="text" id="p-ean" placeholder="C√≥digo de Barras">
                    <input type="text" id="p-nome" placeholder="Nome do Produto">
                    
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="p-grupo" placeholder="Categoria">
                        <input type="text" id="p-area" placeholder="Local">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <input type="number" id="p-custo" placeholder="Custo R$">
                        <input type="number" id="p-venda" placeholder="Venda R$">
                    </div>
                    <div style="display:flex; gap:10px;">
    <input type="number" id="p-qtd" placeholder="Qtd">
    <input type="date" id="p-val">
</div>

<select id="p-tipo" style="margin-top:10px;">
    <option value="un">Unidade</option>
    <option value="kg">Por Peso (kg)</option>
</select>

                    <div style="margin-top:15px; text-align:center;">
                        <label class="btn btn-gold" style="font-size: 0.8rem; border-style: dashed; padding: 10px;">
                            <i class="fa-solid fa-image"></i> TIRAR FOTO
                            <input type="file" accept="image/*" capture="environment" id="p-img" hidden onchange="compressImg(this)">
                        </label>
                        <div id="img-status" style="font-size: 0.7rem; color: var(--green-neon); margin-top:5px;"></div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:25px;">
                        <button class="btn btn-blue" onclick="saveProd()">SALVAR</button>
                        <button class="btn btn-red" onclick="deleteProd()">EXCLUIR</button>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap: 10px;">
                        <b style="color:var(--gold)">LISTA</b>
                        <input type="text" id="search-inventory" placeholder="Filtrar lista..." oninput="listInventory()" style="margin:0; padding:5px 10px; font-size:0.8rem; flex:1;">
                        <select id="filter-list" onchange="listInventory()" style="width:auto; margin:0; padding:5px 10px; font-size:0.8rem;">
                            <option value="todos">TODOS</option>
                            <option value="validade">VALIDADE</option>
                            <option value="grupo">CATEGORIA</option>
                            <option value="falta">FALTANDO</option>
                        </select>
                    </div>
                    <div id="prod-list-container" style="margin-top:15px; max-height: 250px;"></div>
                </div>
            </div>

            <div id="view-relatorios" class="hidden">
                <div class="card">
                    <h3 style="text-align:center; color:var(--gold); margin-top:0;">CENTRAL DE RELAT√ìRIOS</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(1)">DI√ÅRIO</button>
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(7)">SEMANAL</button>
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(15)">QUINZENAL</button>
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(30)">MENSAL</button>
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(90)">TRIMESTRAL</button>
                        <button class="btn btn-gold" style="font-size:0.75rem;" onclick="generateReport(365)">ANUAL</button>
                    </div>
                </div>

                <div class="card">
                    <h4 style="color:var(--blue-neon); margin-top:0;">TESTE DE INTERFACE (√ÅUDIO)</h4>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('bip')">BIP</button>
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('caixa')">CAIXA</button>
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('erro')">ERRO</button>
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('alerta')">ALERTA</button>
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('troca')">TROCA</button>
                        <button class="btn btn-gold" style="padding:8px; font-size:0.6rem;" onclick="play('limpar')">LIMPAR</button>
                    </div>
                </div>

                <div class="card">
                    <button class="btn btn-blue" style="margin-bottom:12px;" onclick="exportBackup()"><i class="fa-solid fa-download"></i> EXPORTAR BACKUP</button>
                    <label class="btn btn-gold" style="font-size: 0.8rem;">
                        <i class="fa-solid fa-upload"></i> RESTAURAR DADOS
                        <input type="file" id="import-btn" hidden onchange="importBackup(this)">
                    </label>
                </div>
            </div>
        </div>

        <nav>
            <div class="nav-item active" onclick="tab('vendas', this)"><i class="fa-solid fa-chart-pie"></i>VENDAS</div>
            <div class="nav-item" onclick="tab('balcao', this)"><i class="fa-solid fa-cash-register"></i>BALC√ÉO</div>
            <div class="nav-item" onclick="tab('estoque', this)"><i class="fa-solid fa-boxes-stacked"></i>ESTOQUE</div>
            <div class="nav-item" onclick="tab('relatorios', this)"><i class="fa-solid fa-file-pdf"></i>RELS</div>
        </nav>
    </div>

    <div id="report-modal" class="hidden">
        <h3 id="report-title" style="color:var(--gold); margin-top:0;"></h3>
        <div id="report-content" class="scroll-area" style="flex:1;"></div>
        <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn btn-blue" onclick="saveReportPDF()">PDF <i class="fa-solid fa-file-export"></i></button>
            <button class="btn btn-red" onclick="document.getElementById('report-modal').classList.add('hidden')">FECHAR</button>
        </div>
    </div>
<!-- MODAL PESO PROFISSIONAL -->
<div id="peso-modal" class="hidden" 
style="position:fixed; inset:0; background:rgba(0,0,0,0.7); 
display:flex; align-items:center; justify-content:center; z-index:100002;">

    <div style="background:var(--card); padding:30px; border-radius:25px; 
    border:2px solid var(--gold); width:90%; max-width:400px; text-align:center;">

        <h3 style="color:var(--gold); margin-top:0;">PRODUTO POR PESO</h3>
        <div id="peso-prod-nome" style="margin-bottom:15px; font-weight:700;"></div>

        <input type="number" step="0.001" id="peso-input" 
        placeholder="Digite o peso em KG (ex: 0.150)" 
        style="text-align:center; font-size:1.2rem;">

        <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-blue" onclick="confirmPeso()">CONFIRMAR</button>
            <button class="btn btn-red" onclick="cancelPeso()">CANCELAR</button>
        </div>
    </div>
</div>
    <div id="scanner">
        <video id="video" style="width:100%; height:100%; object-fit:cover;"></video>
        <div style="position: absolute; top: 20%; left: 10%; right: 10%; height: 2px; background: red; box-shadow: 0 0 10px red; animation: scanAnim 2s infinite;"></div>
        <button onclick="stopScan()" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); padding:15px 40px; border-radius:40px; background:var(--red-neon); color:white; border:none; font-weight:bold;">SAIR DO SCANNER</button>
    </div>

    <style> @keyframes scanAnim { 0% {top: 20%;} 50% {top: 80%;} 100% {top: 20%;} } </style>

    <script>
        /**
         * BrunoStock Ultimate Neon - Engine Core
         * Desenvolvido por Carlos Fran√ßa
         * Vers√£o 6.2 - Estendida e Auditada
         */

        let db; 
        let pAcc = ""; 
        let cart = []; 
        let alertMuted = false; 
        let currentImg = "";
        let currentReportData = null;
        let simulationMode = false; // Modo oculto de simula√ß√£o
        let produtoPesoTemp = null;

        // Inicializa√ß√£o do Banco de Dados IndexedDB
        const openReq = indexedDB.open("BrunoStock_Ultimate_V6", 2);
        
        openReq.onerror = (e) => {
            console.error("Erro ao abrir IndexedDB:", e);
            alert("Erro cr√≠tico no banco de dados.");
        };

        openReq.onsuccess = (e) => { 
            db = e.target.result; 
            updateDashboard(); 
            if(localStorage.getItem("br_auth")) login(); 
        };

        openReq.onupgradeneeded = (e) => {
    let d = e.target.result;

    // Tabela de Produtos
    if (!d.objectStoreNames.contains("products")) {
        d.createObjectStore("products", { keyPath: "ean" });
    }

    // Tabela de Vendas
    if (!d.objectStoreNames.contains("sales")) {
        d.createObjectStore("sales", { keyPath: "id", autoIncrement: true });
    }

    // Tabela de Logs
    if (!d.objectStoreNames.contains("logs")) {
        d.createObjectStore("logs", { keyPath: "id", autoIncrement: true });
    }

    // Tabela de Vales
    if (!d.objectStoreNames.contains("vouchers")) {
        d.createObjectStore("vouchers", { keyPath: "id", autoIncrement: true });
    }
    // Tabela de Caixa Di√°rio
    if (!d.objectStoreNames.contains("cashflow")) {
    d.createObjectStore("cashflow", { keyPath: "date" });
    }
};

        // Fun√ß√µes de Utilidade Geral
        function play(s) { 
            const a = document.getElementById('snd-'+s); 
            if(a) { 
                a.currentTime = 0; 
                a.play().catch(() => {
                    console.warn("Reprodu√ß√£o de √°udio bloqueada pelo navegador.");
                }); 
            } 
        }

        function toggleTheme() { document.body.classList.toggle('light'); }

        function togglePrivacy() { 
            document.querySelectorAll('.privacy-target').forEach(t => t.classList.toggle('blur-value')); 
            document.getElementById('eye-icon').classList.toggle('fa-eye-slash'); 
        }

        function muteAlert() { 
            alertMuted = true; 
            document.getElementById('venc-box').classList.add('hidden'); 
        }

        function resetPin() { 
            pAcc = ''; 
            document.querySelectorAll('.dot').forEach(d => d.style.background = 'none'); 
        }

        function typePin(n) {
            if(pAcc.length < 4) {
                pAcc += n; 
                document.querySelectorAll('.dot')[pAcc.length-1].style.background = "var(--gold)";
                // PIN normal (5584)
if(pAcc === "5584") {
    simulationMode = false;
    login();
    return;
}

// PIN oculto de simula√ß√£o
if(pAcc === "9454") {
    simulationMode = true;
    login();
    return;
}

// Reset se exceder tamanho m√°ximo
if(pAcc.length >= 12) {
    play('erro');
    resetPin();
    alert("PIN INCORRETO");
}
            }
        }

        function login() { 
            localStorage.setItem("br_auth","1"); 
            document.getElementById('pinScreen').classList.add('hidden'); 
            document.getElementById('mainApp').classList.remove('hidden'); 
            listInventory();
        }

        function logout() { 
            localStorage.removeItem("br_auth"); 
            location.reload(); 
        }

        function tab(t, el) {
            document.querySelectorAll('.container > div').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            if(t === 'vendas') updateDashboard();
            if(t === 'estoque') listInventory();
        }

        // --- GEST√ÉO DE ESTOQUE ---
        function saveProd() {
            const p = { 
    ean: document.getElementById('p-ean').value.trim(), 
    nome: document.getElementById('p-nome').value.trim(), 
    grupo: document.getElementById('p-grupo').value || 'Geral',
    area: document.getElementById('p-area').value || 'Loja',
    custo: parseFloat(document.getElementById('p-custo').value || 0), 
    venda: parseFloat(document.getElementById('p-venda').value || 0), 
    qtd: parseFloat(document.getElementById('p-qtd').value || 0),
    validade: document.getElementById('p-val').value,
    tipo: document.getElementById('p-tipo').value,
    foto: currentImg 
};
            
            if(!p.ean || !p.nome) return alert("EAN e Nome s√£o obrigat√≥rios!");

            const tx = db.transaction("products", "readwrite");
            tx.objectStore("products").put(p);
            
            tx.oncomplete = () => {
                play('bip'); 
                clearFields(); 
                listInventory();
                logAction("Produto Salvo/Editado: " + p.nome);
            };
        }

        function deleteProd() {
            const ean = document.getElementById('p-ean').value;
            if(!ean) return alert("Selecione um produto para excluir.");
            if(confirm("Tem certeza que deseja excluir este produto?")) {
                const tx = db.transaction("products", "readwrite");
                tx.objectStore("products").delete(ean);
                tx.oncomplete = () => {
                    play('limpar');
                    clearFields();
                    listInventory();
                    logAction("Produto Exclu√≠do: " + ean);
                };
            }
        }

       function listInventory() {
    const cont = document.getElementById('prod-list-container');
    const filter = document.getElementById('filter-list').value;
    const search = document.getElementById('search-inventory').value.toLowerCase();
    cont.innerHTML = "";

    db.transaction("products").objectStore("products").getAll().onsuccess = (e) => {
        let prods = e.target.result;

        if(search) {
            prods = prods.filter(p => 
                p.nome.toLowerCase().includes(search) || 
                p.ean.includes(search)
            );
        }

        // Ordena√ß√£o base
        prods.sort((a,b)=>a.nome.localeCompare(b.nome));

        // Agrupar por grupo
        const grupos = {};

        prods.forEach(p => {
            if(!grupos[p.grupo]) grupos[p.grupo] = [];
            grupos[p.grupo].push(p);
        });

        Object.keys(grupos).sort().forEach(grupoNome => {

            const headerGrupo = document.createElement('div');
            headerGrupo.className = "group-header";
            headerGrupo.innerHTML = `üì¶ ${grupoNome.toUpperCase()}`;
            cont.appendChild(headerGrupo);

            // Ordenar por validade dentro do grupo
            grupos[grupoNome].sort((a,b)=>{
                if(!a.validade) return 1;
                if(!b.validade) return -1;
                return new Date(a.validade) - new Date(b.validade);
            });

            let validadeAtual = "";

            grupos[grupoNome].forEach(p => {

                // Separador por validade
                if(p.validade !== validadeAtual) {
                    validadeAtual = p.validade;

                    const headerVal = document.createElement('div');
                    headerVal.className = "validade-header";
                    headerVal.innerHTML = `üìÖ ${validadeAtual || "SEM VALIDADE"}`;
                    cont.appendChild(headerVal);
                }

                const div = document.createElement('div');
                div.className = 'prod-row';
                div.onclick = () => { fillForm(p.ean); tab('estoque'); };

                const statusCor = p.qtd <= 0 
                    ? 'var(--red-neon)' 
                    : (p.qtd < 5 ? 'var(--gold)' : 'var(--green-neon)');

                div.innerHTML = `
                    <div style="min-width:280px;">
                        <b style="color:${statusCor}">${p.nome}</b><br>
                        <small>Qtd: ${p.qtd} | EAN: ${p.ean} | Loc: ${p.area}</small>
                    </div>
                    <div style="text-align:right; min-width:110px;">
                        <b style="color:var(--gold)">R$ ${p.venda.toFixed(2)}</b>
                    </div>
                `;

                cont.appendChild(div);
            });
        });
    };
}

        // --- SISTEMA DE BALC√ÉO E CARRINHO ---
        function quickSearchBalcao(val) {
            const resBox = document.getElementById('quick-results');
            if(val.length < 2) { resBox.innerHTML = ""; return; }
            
            db.transaction("products").objectStore("products").getAll().onsuccess = (e) => {
                const matches = e.target.result.filter(p => p.nome.toLowerCase().includes(val.toLowerCase()) || p.ean.includes(val)).slice(0, 5);
                resBox.innerHTML = matches.map(p => `
                    <div class="prod-row" onclick="handleBip('${p.ean}', 1); document.getElementById('quick-results').innerHTML=''; document.getElementById('search-balcao').value=''">
                        <span>${p.nome}</span>
                        <b>R$ ${p.venda.toFixed(2)}</b>
                    </div>
                `).join('');
            };
        }

        function handleBip(ean, mult) {
            db.transaction("products").objectStore("products").get(ean).onsuccess = (e) => {
                const p = e.target.result;
                if(p) {
// Se for produto por peso
if(p.tipo === "kg") {
    produtoPesoTemp = { produto: p, mult: mult };
    document.getElementById("peso-prod-nome").innerText = p.nome + " - R$ " + p.venda.toFixed(2) + " /kg";
    document.getElementById("peso-input").value = "";
    document.getElementById("peso-modal").classList.remove("hidden");
    document.getElementById("peso-input").focus();
    return;
}
                    const existing = cart.find(item => item.ean === ean && (mult > 0 ? item.venda > 0 : item.venda < 0));
                    if(existing) {
                        existing.item_qty++;
                    } else {
                        cart.push({...p, item_qty: 1, base_venda: p.venda, base_custo: p.custo, venda: p.venda * mult, custo: p.custo * mult});
                    }
                    play(mult < 0 ? 'troca' : 'bip'); 
                    renderCart();
                } else { 
                    play('erro'); 
                    alert("PRODUTO N√ÉO ENCONTRADO NO SISTEMA!"); 
                }
            };
        }

        function renderCart() {
            const box = document.getElementById('cart-items'); 
            box.innerHTML = ""; 
            let totalGeral = 0;

            cart.forEach((item, index) => {
                const subtotal = item.venda * item.item_qty;
                totalGeral += subtotal;

                const div = document.createElement('div');
                div.className = 'cart-item-ui';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <b>${item.nome} ${item.venda < 0 ? '(TROCA)' : ''}</b>
                        <span>R$ ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="cart-controls">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        <span>${item.tipo === 'kg' ? item.item_qty + ' kg' : item.item_qty + ' un'}</span>
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                        <i class="fa-solid fa-trash-can" onclick="removeFromCart(${index})" style="color:var(--red-neon); margin-left:auto; cursor:pointer;"></i>
                    </div>
                `;
                box.appendChild(div);
            });

            document.getElementById('cart-total').innerText = "R$ " + Math.abs(totalGeral).toFixed(2);
        }

        function updateQty(idx, delta) {
            cart[idx].item_qty += delta;
            if(cart[idx].item_qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            play('limpar');
            renderCart();
        }

        function clearCart() { 
            if(confirm("Deseja realmente limpar todo o carrinho?")) { 
                cart = []; 
                renderCart(); 
                play('limpar'); 
            } 
        }

        function closeSale() {
            if(!cart.length) return alert("Carrinho vazio!");
// Se estiver em modo simula√ß√£o, n√£o registrar venda
if(simulationMode) {
    play('caixa');
    alert("VENDA SIMULADA (MODO TESTE)");
    cart = [];
    renderCart();
    return;
}
            const method = document.getElementById('pay-method').value;
            
            let totalVenda = 0;
            let totalCusto = 0;
            
            cart.forEach(item => {
                totalVenda += (item.venda * item.item_qty);
                totalCusto += (item.custo * item.item_qty);
            });

            const tx = db.transaction(["sales", "products"], "readwrite");
            
            tx.objectStore("sales").add({ 
                date: new Date().toISOString().split('T')[0], 
                timestamp: new Date().getTime(),
                total: totalVenda, 
                custo: totalCusto, 
                lucro: (totalVenda - totalCusto), 
                metodo: method,
                itens: cart.map(i => ({n: i.nome, q: i.item_qty}))
            });

            cart.forEach(item => {
                const pStore = tx.objectStore("products");
                pStore.get(item.ean).onsuccess = (e) => {
                    let prod = e.target.result;
                    if(prod) {
                        // Se venda > 0, subtrai do estoque. Se troca (negativo), devolve ao estoque.
                        const operacao = item.venda > 0 ? item.item_qty : -item.item_qty;
                        prod.qtd -= operacao;
                        pStore.put(prod);
                    }
                };
            });

            tx.oncomplete = () => { 
                play('caixa'); 
                logAction(`Venda Finalizada: R$ ${totalVenda.toFixed(2)} (${method})`);
                cart = []; 
                renderCart(); 
                updateDashboard();
                alert("VENDA CONCLU√çDA COM SUCESSO!");
            };
        }

        // --- DASHBOARD E ALERTAS ---
        function updateDashboard() {
    const hoje = new Date().toISOString().split('T')[0];

    // üîΩ CARREGAR CAIXA INICIAL DO DIA
    db.transaction("cashflow").objectStore("cashflow").get(hoje).onsuccess = (e) => {
        if(e.target.result) {
            document.getElementById("cash-start").value = e.target.result.valor;
            document.getElementById("cash-status").innerText = "Caixa carregado automaticamente.";
        }
    };

    let v=0, l=0, f=0, c=0, a=0;

            db.transaction("sales").objectStore("sales").getAll().onsuccess = (e) => {
                e.target.result.forEach(s => {
                    if(s.date === hoje) {
                        if(s.metodo === 'casa') c += s.custo; 
                        else if(s.metodo === 'avaria') a += Math.abs(s.custo);
                        else { 
                            v += s.total; 
                            l += s.lucro; 
                            if(s.metodo === 'fiado') f += s.total; 
                        }
                    }
                });
                document.getElementById('dash-vendas').innerText = "R$ " + v.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('dash-lucro').innerText = "R$ " + l.toFixed(2);
                document.getElementById('dash-fiado').innerText = "R$ " + f.toFixed(2);
                document.getElementById('dash-casa').innerText = "R$ " + c.toFixed(2);
                document.getElementById('dash-perda').innerText = "R$ " + a.toFixed(2);
            };

            // Verifica√ß√£o de Validades Pr√≥ximas (15 dias)
            const lv = document.getElementById('venc-list'); 
            lv.innerHTML = "";
            db.transaction("products").objectStore("products").getAll().onsuccess = (e) => {
                let count = 0;
                const hojeData = new Date();
                e.target.result.forEach(p => {
                    if(p.validade) {
                        const diff = (new Date(p.validade) - hojeData) / (1000 * 60 * 60 * 24);
                        if(diff <= 15) {
                            count++;
                            lv.innerHTML += `<div style="padding:4px 0; border-bottom:1px solid rgba(255,0,0,0.1)">‚ö†Ô∏è ${p.nome} - Vence em: ${p.validade}</div>`;
                        }
                    }
                });
                if(count > 0 && !alertMuted) { 
                    document.getElementById('venc-box').classList.remove('hidden'); 
                    play('alerta'); 
                }
            };
        }

        // --- RELAT√ìRIOS E AUDITORIA ---
        function logAction(msg) {
            const tx = db.transaction("logs", "readwrite");
            tx.objectStore("logs").add({
                msg: msg,
                time: new Date().toLocaleString()
            });
        }

        function generateReport(days) {

    const limit = new Date();
    limit.setDate(new Date().getDate() - days);

    let totals = { v:0, l:0, f:0, c:0, a:0 };
    let caixaInicial = 0;

    db.transaction("sales").objectStore("sales").getAll().onsuccess = (e) => {

        e.target.result.forEach(s => {
            if(new Date(s.date) >= limit) {
                if(s.metodo === 'casa') totals.c += s.custo;
                else if(s.metodo === 'avaria') totals.a += Math.abs(s.custo);
                else {
                    totals.v += s.total;
                    totals.l += s.lucro;
                    if(s.metodo === 'fiado') totals.f += s.total;
                }
            }
        });

        db.transaction("cashflow").objectStore("cashflow").getAll().onsuccess = (ev) => {

            ev.target.result.forEach(c => {
                if(new Date(c.date) >= limit) {
                    caixaInicial += c.valor;
                }
            });

            currentReportData = { ...totals, caixaInicial, days };

            const labels = {
                1:'Di√°rio',
                7:'Semanal',
                15:'Quinzenal',
                30:'Mensal',
                90:'Trimestral',
                365:'Anual'
            };

            document.getElementById('report-title').innerText =
                "Resumo " + labels[days];

            document.getElementById('report-content').innerHTML = `
                <div class="report-line"><span>Caixa Inicial:</span><b>R$ ${caixaInicial.toFixed(2)}</b></div>
                <div class="report-line"><span>Total Bruto:</span><b>R$ ${totals.v.toFixed(2)}</b></div>
                <div class="report-line"><span>Lucro Estimado:</span><b style="color:var(--green-neon)">R$ ${totals.l.toFixed(2)}</b></div>
                <div class="report-line"><span>Total em Fiado:</span><b style="color:var(--red-neon)">R$ ${totals.f.toFixed(2)}</b></div>
                <div class="report-line"><span>Gasto Operacional (Casa):</span><b>R$ ${totals.c.toFixed(2)}</b></div>
                <div class="report-line"><span>Preju√≠zo (Avarias):</span><b>R$ ${totals.a.toFixed(2)}</b></div>
                <hr style="border:0; border-top:1px dashed var(--gold); margin:15px 0;">
                <div style="font-size:0.7rem; color:#888;">
                    Relat√≥rio gerado automaticamente pelo sistema de auditoria BrunoStock.
                </div>
            `;

            document.getElementById('report-modal').classList.remove('hidden');

        };

    };

}

        async function saveReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toLocaleString();
            
            doc.setFillColor(3, 3, 5);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 204, 0);
            doc.setFontSize(22); doc.text("BrunoStock Ultimate ‚Äî Relat√≥rio", 15, 25);
            
            doc.setTextColor(100);
            doc.setFontSize(10); doc.text("Emissor: Carlos Fran√ßa | Data: " + dateStr, 15, 35);
            
            const data = [
                ["Indicador Financeiro", "Valor Apurado"],
                ["Total em Vendas (Entrada)", `R$ ${currentReportData.v.toFixed(2)}`],
                ["Lucro L√≠quido Real", `R$ ${currentReportData.l.toFixed(2)}`],
                ["Cr√©dito em Aberto (Fiados)", `R$ ${currentReportData.f.toFixed(2)}`],
                ["Consumo Administrativo", `R$ ${currentReportData.c.toFixed(2)}`],
                ["Perdas/Avarias (Preju√≠zo)", `R$ ${currentReportData.a.toFixed(2)}`]
            ];

            doc.autoTable({ 
                head: [data[0]], 
                body: data.slice(1), 
                startY: 50, 
                theme: 'grid',
                headStyles: { fillColor: [255, 204, 0], textColor: [0, 0, 0] }
            });

            doc.save(`Relatorio_BrunoStock_${currentReportData.days}_dias.pdf`);
        }

        // --- FUN√á√ïES DO SCANNER ZXING ---
        const reader = new ZXing.BrowserMultiFormatReader();
        function openScan(mode) {
    document.getElementById('scanner').style.display = 'block';

    reader.decodeFromVideoDevice(null, 'video', (res) => {
        if(res) {
            if(mode === 'estoque') {
                fillForm(res.text);
            } else {
                handleBip(res.text, mode === 'troca' ? -1 : 1);
            }

            play('bip');

            // Pequeno delay para evitar leitura duplicada imediata
            setTimeout(() => {}, 800);
        }
    });
}
        function stopScan() { 
            reader.reset(); 
            document.getElementById('scanner').style.display = 'none'; 
        }

        // --- AUXILIARES T√âCNICOS ---
        function fillForm(ean) {
            db.transaction("products").objectStore("products").get(ean).onsuccess = (e) => {
                const p = e.target.result;
                if(p) {
                    ['ean','nome','custo','venda','qtd','val','grupo','area'].forEach(f => {
                        const el = document.getElementById('p-'+f);
                        if(el) el.value = p[f] || (f==='val'?'':"");
                    });
                    currentImg = p.foto || "";
                    document.getElementById('img-status').innerText = currentImg ? "üì∏ Foto Carregada" : "";
                } else {
                    document.getElementById('p-ean').value = ean;
                }
            };
        }

        function generateManualCode() { 
            const code = "INT" + Date.now().toString().slice(-6);
            document.getElementById('p-ean').value = code; 
        }

        function clearFields() { 
            ['p-ean','p-nome','p-custo','p-venda','p-qtd','p-val','p-grupo','p-area'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = "";
            });
            currentImg = ""; 
            document.getElementById('img-status').innerText = "";
        }

        function compressImg(input) {
            const file = input.files[0]; 
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 400;
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentImg = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('img-status').innerText = "‚úÖ Foto Processada";
                };
            };
            reader.readAsDataURL(file);
        }

        // --- BACKUP E RESTAURA√á√ÉO ---
        function exportBackup() {
            const backup = { products: [], sales: [], logs: [] };
            const tx = db.transaction(["products", "sales", "logs"], "readonly");
            
            tx.objectStore("products").getAll().onsuccess = (e) => backup.products = e.target.result;
            tx.objectStore("sales").getAll().onsuccess = (e) => backup.sales = e.target.result;
            tx.objectStore("logs").getAll().onsuccess = (e) => backup.logs = e.target.result;

            tx.oncomplete = () => {
                const blob = new Blob([JSON.stringify(backup)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `BrunoStock_Backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                logAction("Backup Exportado");
            };
        }

        function importBackup(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();

    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);

            const tx = db.transaction(["products", "sales", "logs"], "readwrite");

            if(data.products)
                data.products.forEach(p => tx.objectStore("products").put(p));

            if(data.sales)
                data.sales.forEach(s => tx.objectStore("sales").put(s));

            if(data.logs)
                data.logs.forEach(l => tx.objectStore("logs").put(l));

            tx.oncomplete = () => {
                alert("DADOS RESTAURADOS COM SUCESSO!");
                location.reload();
            };

        } catch(err) {
            alert("Erro ao ler arquivo de backup.");
        }
    };

    reader.readAsText(file);
}
// Ano autom√°tico no PIN
document.addEventListener("DOMContentLoaded", function () {
    const year = new Date().getFullYear();
    const el = document.getElementById("pin-copyright");
    if (el) {
        el.innerText = `¬© ${year} Carlos Fran√ßa ‚Äî All Rights Reserved`;
    }
});
function confirmPeso() {
    const peso = parseFloat(document.getElementById("peso-input").value);
    if(!peso || peso <= 0) return alert("Peso inv√°lido.");

    const p = produtoPesoTemp.produto;
    const mult = produtoPesoTemp.mult;

    cart.push({
        ...p,
        item_qty: peso,
        base_venda: p.venda,
        base_custo: p.custo,
        venda: p.venda * mult,
        custo: p.custo * mult
    });

    document.getElementById("peso-modal").classList.add("hidden");
    play(mult < 0 ? 'troca' : 'bip');
    renderCart();
}

function cancelPeso() {
    document.getElementById("peso-modal").classList.add("hidden");
    produtoPesoTemp = null;
}
// FUNDO DOURADO ANIMADO PIN
document.addEventListener("DOMContentLoaded", function () {

    const canvas = document.getElementById("goldParticles");
    if(!canvas) return;

    const ctx = canvas.getContext("2d");
    let particles = [];
    let w, h;

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
    }

    window.addEventListener("resize", resize);
    resize();

    for(let i = 0; i < 60; i++) {
        particles.push({
            x: Math.random() * w,
            y: Math.random() * h,
            r: Math.random() * 2 + 1,
            d: Math.random() * 0.5 + 0.2
        });
    }

    function draw() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "rgba(212,175,55,0.6)";
        particles.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fill();
        });
        update();
        requestAnimationFrame(draw);
    }

    function update() {
        particles.forEach(p => {
            p.y -= p.d;
            if(p.y < 0) {
                p.y = h;
                p.x = Math.random() * w;
            }
        });
    }

    draw();
});
function saveCashStart() {
    const valor = parseFloat(document.getElementById("cash-start").value || 0);
    const hoje = new Date().toISOString().split('T')[0];

    const tx = db.transaction("cashflow", "readwrite");
    tx.objectStore("cashflow").put({
        date: hoje,
        valor: valor
    });

    tx.oncomplete = () => {
        document.getElementById("cash-status").innerText = "Caixa salvo para hoje.";
    };
}
    </script>
<footer class="dev-signature">
    <div>Sistema de Gest√£o Profissional</div>
    <div>Software Engineer | Front-End Architecture</div>
    <div>Desenvolvido por Carlos Fran√ßa</div>
    <div>desenvolvedorcarlosfranca@gmail.com</div>
</footer>
</body>
</html>